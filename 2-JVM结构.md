# 2 JVM结构

本章要定义的是抽象的东西。这里并不介绍JVM的某种特定实现。

要想正确实现JVM，你要做的就是能读懂`class`文件格式，并且能正确的执行它里面要求你干的事儿。JVM规范并不约束其实现细节，这样会限制大家的想象力。比如运行时数据区的内存结构，垃圾回收算法，以及JVM指令的内部优化（比如如何将其翻译成机器代码），这些事儿都分离到具体实现中去了。

本书中使用的Unicode都遵照了*Unicode标准，第13版*，想了解的可以去看`https://www.unicode.org/`。

## 2.1 class文件结构

编译后拿给JVM执行的代码采用了与硬件和操作系统无关的二进制格式，一般（但不是必须）保存再文件中，也就是`class`文件格式。`class`文件格式精确的定义了类或接口的展现形式，包括内部细节，比如特定平台上对象文件格式需要确定它的某种字节序。

第4章“class文件格式”会详细介绍`class`文件格式。

## 2.2 数据类型

和Java语言类似，JVM也会操作两种类型：*基本类型*和*引用类型*。也就是说，变量中保存的，参数所传递的，方法所返回的，以及你可以操作的也就是这两种值：*基本类型值*和*引用类型值*。

JVM希望几乎所有的类型检查都能再运行时之前完成，通常是让编译器完成，而不是让JVM来干。基本类型的值不需要被标记或者具备可探测性才能在运行时判断出它们的类型，也不需要从引用类型的值中区别出来。因为JVM指令集会使用类型特定的指令来区分出它们所操作的操作数的类型。比如`iadd`，`ladd`，`fadd`，`dadd`都属于JVM指令，都是操作两个数字值，并产生一个数字结果，但每一个都有其特定的操作数类型，分别是：`int`，`long`，`float`，`double`。关于JVM指令集中支持的类型可以看§2.11.1。

JVM包含了关于对象的明确支持。一个对象要么是一个动态分配的类实例，要么是一个数组。对象的引用对应JVM中的`reference`类型。`reference`类型的值则被认为是对象的指针。一个对象可以有多个引用。对象的操作、传递和测试总是要基于`reference`类型的值。

## 2.3 基本类型和值

JVM支持的基本数据类型包括*数字类型*，`boolean`类型（§2.3.4）以及`returnAddress`类型（§2.3.3）。

数字类型包括*整型*（§2.3.1）和*浮点型*（§2.3.2）。

整型包括：

- `byte`，8位二进制有符号整数，默认值为零
- `short`，16位二进制有符号整数，默认值为零
- `int`，32位二进制有符号整数，默认值位零
- `long`，64位二进制有符号整数，默认值位零
- `char`，16位无符号整数，表示基本多文种平面（BMP）中的Unicode代码点，基于UTF-16编码，默认值位null代码点（'`\u0000`'）

浮点型包括：

- `float`，严格遵守IEEE 754中定义的binary32格式，默认值为正零
- `double`，严格遵守IEEE 754中定义的binary64格式，默认值为正零

`boolean`类型就是对`true`和`false`进行编码，默认值是`false`。

<pre></pre>